import email
from email import policy
from email.parser import BytesParser
import dns.resolver
import extract_msg

def get_mx_records(domain):
    try:
        mx_records = dns.resolver.resolve(domain, 'MX')
        return [str(record.exchange) for record in mx_records]
    except (dns.resolver.NoAnswer, dns.resolver.NXDOMAIN):
        return None  # MX-записи не найдены
    except Exception as e:
        print(f"Ошибка при получении MX-записей для {domain}: {e}")
        return None

def parse_email_headers(msg_file):
    headers = {}

    if msg_file.lower().endswith('.msg'):
        # Извлечение данных из .msg файла
        msg = extract_msg.Message(msg_file)
        headers = {
            'From': msg.sender,
            'To': msg.to,
            'Subject': msg.subject,
            'Date': msg.date,
            'Message-ID': msg.message_id,
            'Return-Path': msg.return_path,
            'Received': msg.received,
        }
    elif msg_file.lower().endswith('.eml'):
        # Открываем файл с письмом в формате .eml
        with open(msg_file, 'rb') as f:
            msg = BytesParser(policy=policy.default).parse(f)
            headers = {
                'From': msg['From'],
                'To': msg['To'],
                'Subject': msg['Subject'],
                'Date': msg['Date'],
                'Message-ID': msg['Message-ID'],
                'Return-Path': msg['Return-Path'],
                'Received': msg.get_all('Received'),
            }
    else:
        print("Неподдерживаемый формат файла.")
        return None

    # Извлекаем информацию о 'Received: from'
    received_from = []
    if headers.get('Received'):
        for received in headers['Received']:
            if 'from ' in received:
                domain = received.split('from ')[1].split(' ')[0]
                received_from.append(domain)
                mx_records = get_mx_records(domain)

                if mx_records:
                    print(f"MX-записи для домена '{domain}': {', '.join(mx_records)}")
                else:
                    print(f"MX-записи для домена '{domain}' не найдены.")

    headers['Received: from'] = received_from
    return headers

# Пример использования
if __name__ == "__main__":
    email_file_path = 'path/to/your/email.msg'  # Укажите путь к файлу .msg или .eml
    headers = parse_email_headers(email_file_path)

    if headers:
        for key, value in headers.items():
            print(f"{key}: {value}")
